# Runs after merge to main

trigger:
- main

variables:
- group: radius-angular

jobs:
  - job: setup_build
    pool:
      vmImage: ubuntu-latest
      steps:
        - task: NodeTool@0
          inputs:
            versionSpec: "14.x"
            displayName: "Install Node.js"
            script: |
              npm ci
              npm run lint
              npm run test
              npm run build:ds
          displayName: "Install lint, test, build DS"
  - job: audit
    steps:
      - task: Npm@1
        displayName: 'npm audit'
        inputs:
          command: custom
          customCommand: 'audit --registry=https://registry.npmjs.org/'
      - task: PublishPipelineArtifact@1
        inputs:
          targetPath: $(System.DefaultWorkingDirectory)/bin/dist
          artifactName: )/bin/dist
        displayName: "Publish dist artifact"
  - job: publish
    steps:
    - task: PowerShell@2
      inputs:
        targetType: 'inline'
        script: 'cd dist/ && npm pack && npm publish'
